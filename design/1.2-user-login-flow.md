# 1.2 User Login Flow

## Mô tả
Flow đăng nhập bằng email và mật khẩu, trả về JWT token.

## Flowchart

```mermaid
flowchart TD
    Start([User mở form đăng nhập]) --> Input[User nhập email, password]
    Input --> ValidateClient{Client validate<br/>sơ bộ}
    ValidateClient -->|Invalid| ShowError1[Hiển thị lỗi validation]
    ShowError1 --> Input
    ValidateClient -->|Valid| Submit[User submit form]
    Submit --> SendRequest[Gửi POST /api/auth/login]
    SendRequest --> ValidateServer{Server validate}
    ValidateServer -->|Email format sai| ReturnError1[Trả lỗi 400: Email không hợp lệ]
    ValidateServer -->|Thiếu password| ReturnError2[Trả lỗi 400: Thiếu mật khẩu]
    ValidateServer -->|Valid| FindUser[Tìm user theo email]
    FindUser -->|User không tồn tại| ReturnError3[Trả lỗi 401: Email hoặc mật khẩu sai]
    FindUser -->|User tồn tại| VerifyPassword{Verify password<br/>với bcrypt}
    VerifyPassword -->|Password sai| ReturnError3
    VerifyPassword -->|Password đúng| GenerateJWT[Tạo JWT token]
    GenerateJWT -->|Lỗi generate| ReturnError4[Trả lỗi 500: Lỗi hệ thống]
    GenerateJWT -->|Thành công| ReturnSuccess[Trả 200: Token + user info]
    ReturnError1 --> ShowError2[Hiển thị lỗi trên UI]
    ReturnError2 --> ShowError2
    ReturnError3 --> ShowError2
    ReturnError4 --> ShowError2
    ShowError2 --> Input
    ReturnSuccess --> SaveToken[Lưu JWT token vào localStorage/cookie]
    SaveToken --> ShowSuccess[Hiển thị thông báo thành công]
    ShowSuccess --> Redirect[Redirect đến trang bảo vệ<br/>dashboard/profile]
    Redirect --> End([Kết thúc])
```

## Luồng chính (Happy Path)
1. User mở form đăng nhập
2. User nhập email và password
3. Client validate sơ bộ
4. User submit form
5. Server validate dữ liệu
6. Server tìm user theo email
7. Server verify password với bcrypt
8. Server generate JWT token
9. Server trả về token và user info
10. Client lưu token vào localStorage/cookie
11. Redirect đến trang bảo vệ (dashboard/profile)

## Luồng lỗi
- Email format không hợp lệ → 400 Bad Request
- Thiếu password → 400 Bad Request
- Email không tồn tại → 401 Unauthorized (không tiết lộ email có tồn tại)
- Password sai → 401 Unauthorized
- Lỗi generate token → 500 Internal Server Error
- Lỗi mạng → Hiển thị thông báo thân thiện

## Security Notes
- Không tiết lộ email có tồn tại hay không (trả cùng lỗi 401)
- JWT token có TTL hợp lý (ví dụ: 24h)
- Token được lưu an toàn (có thể dùng httpOnly cookie)
- Không log plaintext password

