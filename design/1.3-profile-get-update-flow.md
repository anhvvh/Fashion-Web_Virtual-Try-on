# 1.3 Profile Get/Update Flow

## Mô tả
Flow lấy và cập nhật thông tin profile, bao gồm upload ảnh toàn thân vào Supabase Storage.

## Flowchart - Get Profile

```mermaid
flowchart TD
    Start([User mở trang profile]) --> CheckToken{Có JWT token?}
    CheckToken -->|Không có| RedirectLogin[Redirect đến trang login]
    RedirectLogin --> End1([Kết thúc])
    CheckToken -->|Có token| SendRequest[Gửi GET /api/user/profile<br/>với Authorization header]
    SendRequest --> VerifyToken{Server verify JWT token}
    VerifyToken -->|Token không hợp lệ| ReturnError1[Trả lỗi 401: Unauthorized]
    VerifyToken -->|Token hết hạn| ReturnError2[Trả lỗi 401: Token expired]
    VerifyToken -->|Token hợp lệ| GetProfile[Lấy profile từ DB<br/>theo user_id từ token]
    GetProfile -->|Lỗi DB| ReturnError3[Trả lỗi 500: Lỗi hệ thống]
    GetProfile -->|Thành công| ReturnSuccess[Trả 200: Profile data]
    ReturnError1 --> ShowError1[Hiển thị lỗi, redirect login]
    ReturnError2 --> ShowError1
    ReturnError3 --> ShowError2[Hiển thị lỗi hệ thống]
    ShowError1 --> RedirectLogin
    ShowError2 --> End1
    ReturnSuccess --> DisplayProfile[Hiển thị profile trên UI]
    DisplayProfile --> End1
```

## Flowchart - Update Profile

```mermaid
flowchart TD
    Start([User chỉnh sửa profile]) --> Input[User nhập/chỉnh sửa:<br/>- Display name<br/>- Height cm<br/>- Weight kg]
    Input --> SelectImage{User chọn<br/>ảnh mới?}
    SelectImage -->|Có| ValidateImage{Client validate ảnh}
    ValidateImage -->|Sai loại file| ShowError1[Hiển thị lỗi:<br/>Chỉ JPG/PNG]
    ValidateImage -->|Vượt dung lượng| ShowError2[Hiển thị lỗi:<br/>File quá lớn >5MB]
    ValidateImage -->|Ratio không đúng| ShowError3[Hiển thị cảnh báo:<br/>Khuyến nghị ratio 3:4 hoặc 9:16]
    ShowError1 --> Input
    ShowError2 --> Input
    ShowError3 --> Confirm{User xác nhận<br/>tiếp tục?}
    Confirm -->|Không| Input
    Confirm -->|Có| ValidateForm{Validate form data}
    ValidateImage -->|Valid| ValidateForm
    SelectImage -->|Không| ValidateForm
    ValidateForm -->|Height/Weight không hợp lệ| ShowError4[Hiển thị lỗi validation]
    ShowError4 --> Input
    ValidateForm -->|Valid| Submit[User bấm Save]
    Submit --> CheckToken{Có JWT token?}
    CheckToken -->|Không có| RedirectLogin[Redirect đến trang login]
    RedirectLogin --> End1([Kết thúc])
    CheckToken -->|Có token| PrepareData[Chuẩn bị dữ liệu gửi]
    PrepareData --> HasImage{Có ảnh mới?}
    HasImage -->|Có| UploadImage[Upload ảnh lên Supabase Storage]
    UploadImage -->|Lỗi upload| ShowError5[Hiển thị lỗi upload]
    ShowError5 --> Input
    UploadImage -->|Thành công| GetImageURL[Lấy URL ảnh từ Storage]
    GetImageURL --> SendRequest[Gửi PUT /api/user/profile<br/>với data + image URL]
    HasImage -->|Không| SendRequest
    SendRequest --> VerifyToken{Server verify JWT token}
    VerifyToken -->|Token không hợp lệ| ReturnError1[Trả lỗi 401: Unauthorized]
    VerifyToken -->|Token hợp lệ| ValidateServer{Server validate data}
    ValidateServer -->|Height/Weight không hợp lệ| ReturnError2[Trả lỗi 400: Validation error]
    ValidateServer -->|Valid| UpdateProfile[Cập nhật profile trong DB]
    UpdateProfile -->|Lỗi DB| ReturnError3[Trả lỗi 500: Lỗi hệ thống]
    UpdateProfile -->|Thành công| DeleteOldImage{Ảnh cũ<br/>có tồn tại?}
    DeleteOldImage -->|Có| RemoveOldImage[Xóa ảnh cũ khỏi Storage]
    DeleteOldImage -->|Không| ReturnSuccess
    RemoveOldImage --> ReturnSuccess[Trả 200: Profile updated]
    ReturnError1 --> ShowError6[Hiển thị lỗi, redirect login]
    ReturnError2 --> ShowError7[Hiển thị lỗi validation]
    ReturnError3 --> ShowError8[Hiển thị lỗi hệ thống]
    ShowError6 --> RedirectLogin
    ShowError7 --> Input
    ShowError8 --> Input
    ReturnSuccess --> ShowSuccess[Hiển thị thông báo thành công]
    ShowSuccess --> RefreshData[Refresh profile data trên UI]
    RefreshData --> End1
```

## Luồng chính - Get Profile
1. User mở trang profile
2. Client kiểm tra có JWT token
3. Gửi GET request với Authorization header
4. Server verify JWT token
5. Server lấy profile từ DB
6. Trả về profile data
7. Client hiển thị profile

## Luồng chính - Update Profile
1. User chỉnh sửa thông tin (name, height, weight)
2. User chọn ảnh mới (nếu có)
3. Client validate ảnh (loại file, dung lượng, ratio)
4. Client validate form data
5. User bấm Save
6. Nếu có ảnh mới: Upload lên Supabase Storage
7. Gửi PUT request với data và image URL
8. Server verify JWT token
9. Server validate data
10. Server cập nhật profile trong DB
11. Xóa ảnh cũ nếu có
12. Trả về kết quả thành công
13. Client refresh UI

## Luồng lỗi
- Không có token hoặc token không hợp lệ → 401, redirect login
- Token hết hạn → 401, yêu cầu đăng nhập lại
- Ảnh sai loại (không phải JPG/PNG) → Hiển thị lỗi
- Ảnh vượt dung lượng (>5MB) → Hiển thị lỗi
- Ảnh ratio không đúng → Cảnh báo (không chặn)
- Height/Weight không hợp lệ → 400 Bad Request
- Lỗi upload Storage → Hiển thị lỗi
- Lỗi database → 500 Internal Server Error

## Validation Rules
- Height (cm): số, 100-250
- Weight (kg): số, 30-250
- Ảnh: JPG/JPEG/PNG, ≤5MB, ratio khuyến nghị 3:4 hoặc 9:16, min dimension ≥720px
- Email: hiển thị từ profile, không chỉnh sửa

